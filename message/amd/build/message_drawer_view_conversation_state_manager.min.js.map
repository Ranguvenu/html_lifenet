{"version":3,"file":"message_drawer_view_conversation_state_manager.min.js","sources":["../src/message_drawer_view_conversation_state_manager.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * This module operates on the view states from the message_drawer_view_conversation module.\n * It exposes functions that can be used to generate new version of the state.\n *\n * Important notes for this module:\n * 1.) The existing state is always immutable. It should never be modified.\n * 2.) All functions that operate on the state should always clone the state and\n *     modify the cloned state before returning it.\n *\n * It's important that the states remain immutable because they are diff'd in\n * the message_drawer_view_conversation_patcher module in order to work out what\n * has changed.\n *\n * @module     core_message/message_drawer_view_conversation_state_manager\n * @copyright  2018 Ryan Wyllie <ryan@moodle.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\ndefine(['jquery'], function($) {\n\n    /**\n     * Clone a state, a state is a collection of information about the variables required to build\n     * the conversation user interface.\n     *\n     * @param  {Object} state State to clone\n     * @return {Object} newstate A copy of the state to clone.\n     */\n    var cloneState = function(state) {\n        // Do a deep extend to make sure we recursively copy objects and\n        // arrays so that the new state doesn't contain any references to\n        // the old state, e.g. adding a value to an array in the new state\n        // shouldn't also add it to the old state.\n        return $.extend(true, {}, state);\n    };\n\n    /**\n     * Format messages to be used in a state.\n     *\n     * @param  {Array} messages The messages to format.\n     * @param  {Number} loggedInUserId The logged in user id.\n     * @param  {Array} members The converstation members.\n     * @return {Array} Formatted messages.\n     */\n    var formatMessages = function(messages, loggedInUserId, members) {\n        return messages.map(function(message) {\n            var fromLoggedInUser = message.useridfrom == loggedInUserId;\n            return {\n                // Stringify the id.\n                id: \"\" + message.id,\n                fromLoggedInUser: fromLoggedInUser,\n                userFrom: members[message.useridfrom],\n                text: message.text,\n                downloadUrl: message.downloadurl,\n                attachment: message.attachment,\n                timeCreated: message.timecreated ? parseInt(message.timecreated, 10) : null\n            };\n        });\n    };\n\n    /**\n     * Format members to be used in a state.\n     *\n     * @param  {Array} members The messages to format.\n     * @return {Array} Formatted members.\n     */\n    var formatMembers = function(members) {\n        return members.map(function(member) {\n            return {\n                id: member.id,\n                fullname: member.fullname,\n                profileurl: member.profileurl,\n                profileimageurl: member.profileimageurl,\n                profileimageurlsmall: member.profileimageurlsmall,\n                isonline:  member.isonline,\n                showonlinestatus: member.showonlinestatus,\n                isblocked: member.isblocked,\n                iscontact: member.iscontact,\n                isdeleted: member.isdeleted,\n                canmessage: member.canmessage,\n                canmessageevenifblocked: member.canmessageevenifblocked,\n                requirescontact: member.requirescontact,\n                contactrequests: member.contactrequests || []\n            };\n        });\n    };\n\n    /**\n     * Create an initial (blank) state.\n     *\n     * @param  {Number} midnight Midnight time.\n     * @param  {Number} loggedInUserId The logged in user id.\n     * @param  {Number} id The conversation id.\n     * @param  {Number} messagePollMin The message poll start timeout in seconds.\n     * @param  {Number} messagePollMax The message poll max timeout limit in seconds.\n     * @param  {Number} messagePollAfterMax The message poll frequency in seconds to reset to after max limit is reached.\n     * @return {Object} Initial state.\n     */\n    var buildInitialState = function(\n        midnight,\n        loggedInUserId,\n        id,\n        messagePollMin,\n        messagePollMax,\n        messagePollAfterMax\n    ) {\n        return {\n            midnight: midnight,\n            loggedInUserId: loggedInUserId,\n            id: id,\n            messagePollMin: messagePollMin,\n            messagePollMax: messagePollMax,\n            messagePollAfterMax: messagePollAfterMax,\n            name: null,\n            subname: null,\n            type: null,\n            totalMemberCount: null,\n            imageUrl: null,\n            isFavourite: null,\n            isMuted: null,\n            canDeleteMessagesForAllUsers: false,\n            deleteMessagesForAllUsers: false,\n            members: {},\n            messages: [],\n            hasTriedToLoadMessages: false,\n            loadingMessages: true,\n            loadingMembers: true,\n            loadingConfirmAction: false,\n            pendingBlockUserIds: [],\n            pendingUnblockUserIds: [],\n            pendingRemoveContactIds: [],\n            pendingAddContactIds: [],\n            pendingDeleteMessageIds: [],\n            pendingSendMessageIds: [],\n            pendingDeleteConversation: false,\n            selectedMessageIds: [],\n            showEmojiAutoComplete: false,\n            showEmojiPicker: false\n        };\n    };\n\n    /**\n     * Add messages to a state and sort them by timecreated.\n     *\n     * @param  {Object} state Current state.\n     * @param  {Array} messages Messages to add to state.\n     * @return {Object} state New state with added messages.\n     */\n    var addMessages = function(state, messages) {\n        var newState = cloneState(state);\n        var formattedMessages = formatMessages(messages, state.loggedInUserId, state.members);\n        formattedMessages = formattedMessages.map(function(message) {\n            message.sendState = null;\n            message.timeAdded = Date.now();\n            message.errorMessage = null;\n            return message;\n        });\n        var allMessages = state.messages.concat(formattedMessages);\n        // Sort the messages. Oldest to newest.\n        allMessages.sort(function(a, b) {\n            if (a.timeCreated === null && b.timeCreated === null) {\n                if (a.timeAdded < b.timeAdded) {\n                    return -1;\n                } else if (a.timeAdded > b.timeAdded) {\n                    return 1;\n                }\n            }\n\n            if (a.timeCreated === null && b.timeCreated !== null) {\n                // A comes after b.\n                return 1;\n            } else if (a.timeCreated !== null && b.timeCreated === null) {\n                // A comes before b.\n                return -1;\n            } else if (a.timeCreated < b.timeCreated) {\n                // A comes before b.\n                return -1;\n            } else if (a.timeCreated > b.timeCreated) {\n                // A comes after b.\n                return 1;\n            } else if (a.id < b.id) {\n                return -1;\n            } else if (a.id > b.id) {\n                return 1;\n            } else {\n                return 0;\n            }\n        });\n\n        // Filter out any duplicate messages.\n        newState.messages = allMessages.filter(function(message, index, sortedMessages) {\n            return !index || message.id != sortedMessages[index - 1].id;\n        });\n\n        return newState;\n    };\n\n    /**\n     * Update existing messages.\n     *\n     * @param  {Object} state Current state.\n     * @param  {Array} data 2D array of old and new messages\n     * @return {Object} state.\n     */\n    var updateMessages = function(state, data) {\n        var newState = cloneState(state);\n        var updatesById = data.reduce(function(carry, messageData) {\n            var oldMessage = messageData[0];\n            var newMessage = messageData[1];\n            var formattedMessages = formatMessages([newMessage], state.loggedInUserId, state.members);\n            var formattedMessage = formattedMessages[0];\n\n            carry[oldMessage.id] = formattedMessage;\n            return carry;\n        }, {});\n\n        newState.messages = newState.messages.map(function(message) {\n            if (message.id in updatesById) {\n                return $.extend(message, updatesById[message.id]);\n            } else {\n                return message;\n            }\n        });\n\n        return newState;\n    };\n\n    /**\n     * Remove messages from state.\n     *\n     * @param  {Object} state Current state.\n     * @param  {Array} messages Messages to remove from state.\n     * @return {Object} state New state with removed messages.\n     */\n    var removeMessages = function(state, messages) {\n        var newState = cloneState(state);\n        var removeMessageIds = messages.map(function(message) {\n            return \"\" + message.id;\n        });\n        newState.messages = newState.messages.filter(function(message) {\n            return removeMessageIds.indexOf(message.id) < 0;\n        });\n\n        return newState;\n    };\n\n    /**\n     * Remove messages from state by message id.\n     *\n     * @param  {Object} state Current state.\n     * @param  {Array} messageIds Message ids to remove from state.\n     * @return {Object} state New state with removed messages.\n     */\n    var removeMessagesById = function(state, messageIds) {\n        var newState = cloneState(state);\n        messageIds = messageIds.map(function(id) {\n            return \"\" + id;\n        });\n        newState.messages = newState.messages.filter(function(message) {\n            return messageIds.indexOf(message.id) < 0;\n        });\n\n        return newState;\n    };\n\n    /**\n     * Add conversation member to state.\n     *\n     * @param  {Object} state Current state.\n     * @param  {Array} members Conversation members to be added to state.\n     * @return {Object} New state with added members.\n     */\n    var addMembers = function(state, members) {\n        var newState = cloneState(state);\n        var formattedMembers = formatMembers(members);\n        formattedMembers.forEach(function(member) {\n            newState.members[member.id] = member;\n        });\n        return newState;\n    };\n\n    /**\n     * Remove members from state.\n     *\n     * @param  {Object} state Current state.\n     * @param  {Array} members Members to be removed from state.\n     * @return {Object} New state with removed members.\n     */\n    var removeMembers = function(state, members) {\n        var newState = cloneState(state);\n        members.forEach(function(member) {\n            delete newState.members[member.id];\n        });\n        return newState;\n    };\n\n    /**\n     * Set the state loading messages attribute.\n     *\n     * @param  {Object} state Current state.\n     * @param  {Bool} value New loading messages value.\n     * @return {Object} New state with loading messages attribute.\n     */\n    var setLoadingMessages = function(state, value) {\n        var newState = cloneState(state);\n        newState.loadingMessages = value;\n        if (state.loadingMessages && !value) {\n            // If we're going from loading to not loading then\n            // it means we've tried to load.\n            newState.hasTriedToLoadMessages = true;\n        }\n        return newState;\n    };\n\n    /**\n     * Set the state loading members attribute.\n     *\n     * @param  {Object} state Current state.\n     * @param  {Bool} value New loading members value.\n     * @return {Object} New state with loading members attribute.\n     */\n    var setLoadingMembers = function(state, value) {\n        var newState = cloneState(state);\n        newState.loadingMembers = value;\n        return newState;\n    };\n\n    /**\n     * Set the conversation id.\n     *\n     * @param  {Object} state Current state.\n     * @param  {String} value The ID.\n     * @return {Object} New state.\n     */\n    var setId = function(state, value) {\n        var newState = cloneState(state);\n        newState.id = value;\n        return newState;\n    };\n\n    /**\n     * Set the state name attribute.\n     *\n     * @param  {Object} state Current state.\n     * @param  {String} value New name value.\n     * @return {Object} New state with name attribute.\n     */\n    var setName = function(state, value) {\n        var newState = cloneState(state);\n        newState.name = value;\n        return newState;\n    };\n\n    /**\n     * Set the state subname attribute.\n     *\n     * @param  {Object} state Current state.\n     * @param  {String} value New subname value.\n     * @return {Object} New state.\n     */\n    var setSubname = function(state, value) {\n        var newState = cloneState(state);\n        newState.subname = value;\n        return newState;\n    };\n\n    /**\n     * Set the conversation type.\n     *\n     * @param  {Object} state Current state.\n     * @param  {Int} type Conversation type.\n     * @return {Object} New state.\n     */\n    var setType = function(state, type) {\n        var newState = cloneState(state);\n        newState.type = type;\n        return newState;\n    };\n\n    /**\n     * Set whether the conversation is a favourite conversation.\n     *\n     * @param  {Object} state Current state.\n     * @param  {Bool} isFavourite If it's a favourite.\n     * @return {Object} New state.\n     */\n    var setIsFavourite = function(state, isFavourite) {\n        var newState = cloneState(state);\n        newState.isFavourite = isFavourite;\n        return newState;\n    };\n\n    /**\n     * Set whether the conversation is a muted conversation.\n     *\n     * @param  {Object} state Current state.\n     * @param  {bool} isMuted If it's muted.\n     * @return {Object} New state.\n     */\n    var setIsMuted = function(state, isMuted) {\n        var newState = cloneState(state);\n        newState.isMuted = isMuted;\n        return newState;\n    };\n\n    /**\n     * Set the total member count.\n     *\n     * @param  {Object} state Current state.\n     * @param  {String} count The count.\n     * @return {Object} New state.\n     */\n    var setTotalMemberCount = function(state, count) {\n        var newState = cloneState(state);\n        newState.totalMemberCount = count;\n        return newState;\n    };\n\n    /**\n     * Set the conversation image url.\n     *\n     * @param  {Object} state Current state.\n     * @param  {String} url The url to the image.\n     * @return {Object} New state.\n     */\n    var setImageUrl = function(state, url) {\n        var newState = cloneState(state);\n        newState.imageUrl = url;\n        return newState;\n    };\n\n    /**\n     * Set the state loading confirm action attribute.\n     *\n     * @param  {Object} state Current state.\n     * @param  {Bool} value New loading confirm action value.\n     * @return {Object} New state with loading confirm action attribute.\n     */\n    var setLoadingConfirmAction = function(state, value) {\n        var newState = cloneState(state);\n        newState.loadingConfirmAction = value;\n        return newState;\n    };\n\n    /**\n     * Set the state pending delete conversation attribute.\n     *\n     * @param  {Object} state Current state.\n     * @param  {Bool} value New pending delete conversation value.\n     * @return {Object} New state with pending delete conversation attribute.\n     */\n    var setPendingDeleteConversation = function(state, value) {\n        var newState = cloneState(state);\n        newState.pendingDeleteConversation = value;\n        return newState;\n    };\n\n    /**\n     * Set the state of message to pending.\n     *\n     * @param  {Object} state Current state.\n     * @param  {Array} messageIds Messages to delete.\n     * @return {Object} New state with array of pending delete message ids.\n     */\n    var setMessagesSendPendingById = function(state, messageIds) {\n        var newState = cloneState(state);\n        messageIds = messageIds.map(function(id) {\n            return \"\" + id;\n        });\n        newState.messages.forEach(function(message) {\n            if (messageIds.indexOf(message.id) >= 0) {\n                message.sendState = 'pending';\n                message.errorMessage = null;\n            }\n        });\n        return newState;\n    };\n\n    /**\n     * Set the state of message to sent.\n     *\n     * @param  {Object} state Current state.\n     * @param  {Array} messageIds Messages to delete.\n     * @return {Object} New state with array of pending delete message ids.\n     */\n    var setMessagesSendSuccessById = function(state, messageIds) {\n        var newState = cloneState(state);\n        messageIds = messageIds.map(function(id) {\n            return \"\" + id;\n        });\n        newState.messages.forEach(function(message) {\n            if (messageIds.indexOf(message.id) >= 0) {\n                message.sendState = 'sent';\n                message.errorMessage = null;\n            }\n        });\n        return newState;\n    };\n\n    /**\n     * Set the state of messages to error.\n     *\n     * @param  {Object} state Current state.\n     * @param  {Array} messageIds Messages to delete.\n     * @param  {string} errorMessage\n     * @return {Object} New state with array of pending delete message ids.\n     */\n    var setMessagesSendFailById = function(state, messageIds, errorMessage) {\n        var newState = cloneState(state);\n        messageIds = messageIds.map(function(id) {\n            return \"\" + id;\n        });\n        newState.messages.forEach(function(message) {\n            if (messageIds.indexOf(message.id) >= 0) {\n                message.sendState = 'error';\n                message.errorMessage = errorMessage;\n            }\n        });\n        return newState;\n    };\n\n    /**\n     * Set the visibility of the emoji picker.\n     *\n     * @param  {Object} state Current state.\n     * @param  {Bool} show Should the emoji picker be shown.\n     * @return {Object} New state with array of pending delete message ids.\n     */\n    var setShowEmojiPicker = function(state, show) {\n        var newState = cloneState(state);\n        newState.showEmojiPicker = show;\n        return newState;\n    };\n\n    /**\n     * Set whether emojis auto complete suggestions should be shown.\n     *\n     * @param  {Object} state Current state.\n     * @param  {Bool} show Show the autocomplete\n     * @return {Object} New state with array of pending delete message ids.\n     */\n    var setShowEmojiAutoComplete = function(state, show) {\n        var newState = cloneState(state);\n        newState.showEmojiAutoComplete = show;\n        return newState;\n    };\n\n    /**\n     * Set the state pending block userids.\n     *\n     * @param  {Object} state Current state.\n     * @param  {Array} userIds User ids to block.\n     * @return {Object} New state with array of pending block userids.\n     */\n    var addPendingBlockUsersById = function(state, userIds) {\n        var newState = cloneState(state);\n        userIds.forEach(function(id) {\n            newState.pendingBlockUserIds.push(id);\n        });\n        return newState;\n    };\n\n    /**\n     * Set the state pending remove userids.\n     *\n     * @param  {Object} state Current state.\n     * @param  {Array} userIds User ids to remove.\n     * @return {Object} New state with array of pending remove userids.\n     */\n    var addPendingRemoveContactsById = function(state, userIds) {\n        var newState = cloneState(state);\n        userIds.forEach(function(id) {\n            newState.pendingRemoveContactIds.push(id);\n        });\n        return newState;\n    };\n\n    /**\n     * Set the state pending unblock userids.\n     *\n     * @param  {Object} state Current state.\n     * @param  {Array} userIds User ids to unblock.\n     * @return {Object} New state with array of pending unblock userids.\n     */\n    var addPendingUnblockUsersById = function(state, userIds) {\n        var newState = cloneState(state);\n        userIds.forEach(function(id) {\n            newState.pendingUnblockUserIds.push(id);\n        });\n        return newState;\n    };\n\n    /**\n     * Set the state pending add users to contacts userids.\n     *\n     * @param  {Object} state Current state.\n     * @param  {Array} userIds User ids to add users to contacts.\n     * @return {Object} New state with array of pending add users to contacts userids.\n     */\n    var addPendingAddContactsById = function(state, userIds) {\n        var newState = cloneState(state);\n        userIds.forEach(function(id) {\n            newState.pendingAddContactIds.push(id);\n        });\n        return newState;\n    };\n\n    /**\n     * Set the state pending delete messages.\n     *\n     * @param  {Object} state Current state.\n     * @param  {Array} messageIds Messages to delete.\n     * @return {Object} New state with array of pending delete message ids.\n     */\n    var addPendingDeleteMessagesById = function(state, messageIds) {\n        var newState = cloneState(state);\n        messageIds.forEach(function(id) {\n            newState.pendingDeleteMessageIds.push(id);\n        });\n        return newState;\n    };\n\n    /**\n     * Update the state pending block userids.\n     *\n     * @param  {Object} state Current state.\n     * @param  {Array} userIds User ids to remove from the list of user ids to block.\n     * @return {Object} New state with array of pending block userids.\n     */\n    var removePendingBlockUsersById = function(state, userIds) {\n        var newState = cloneState(state);\n        newState.pendingBlockUserIds = newState.pendingBlockUserIds.filter(function(id) {\n            return userIds.indexOf(id) < 0;\n        });\n        return newState;\n    };\n\n    /**\n     * Update the state pending remove userids.\n     *\n     * @param  {Object} state Current state.\n     * @param  {Array} userIds User ids to remove from the list of user ids to remove.\n     * @return {Object} New state with array of pending remove userids.\n     */\n    var removePendingRemoveContactsById = function(state, userIds) {\n        var newState = cloneState(state);\n        newState.pendingRemoveContactIds = newState.pendingRemoveContactIds.filter(function(id) {\n            return userIds.indexOf(id) < 0;\n        });\n        return newState;\n    };\n\n    /**\n     * Update the state pending unblock userids.\n     *\n     * @param  {Object} state Current state.\n     * @param  {Array} userIds User ids to remove from the list of user ids to unblock.\n     * @return {Object} New state with array of pending unblock userids.\n     */\n    var removePendingUnblockUsersById = function(state, userIds) {\n        var newState = cloneState(state);\n        newState.pendingUnblockUserIds = newState.pendingUnblockUserIds.filter(function(id) {\n            return userIds.indexOf(id) < 0;\n        });\n        return newState;\n    };\n\n    /**\n     * Update the state pending add to contacts userids.\n     *\n     * @param  {Object} state Current state.\n     * @param  {Array} userIds User ids to remove from the list of user ids to add to contacts.\n     * @return {Object} New state with array of pending add to contacts userids.\n     */\n    var removePendingAddContactsById = function(state, userIds) {\n        var newState = cloneState(state);\n        newState.pendingAddContactIds = newState.pendingAddContactIds.filter(function(id) {\n            return userIds.indexOf(id) < 0;\n        });\n        return newState;\n    };\n\n    /**\n     * Update the state pending delete messages userids.\n     *\n     * @param  {Object} state Current state.\n     * @param  {Array} messageIds Message ids to remove from the list of messages to delete.\n     * @return {Object} New state with array of messages to delete.\n     */\n    var removePendingDeleteMessagesById = function(state, messageIds) {\n        var newState = cloneState(state);\n        messageIds = messageIds.map(function(id) {\n            return \"\" + id;\n        });\n        newState.pendingDeleteMessageIds = newState.pendingDeleteMessageIds.filter(function(id) {\n            return messageIds.indexOf(id) < 0;\n        });\n        return newState;\n    };\n\n    /**\n     * Add messages to state selected messages.\n     *\n     * @param  {Object} state Current state.\n     * @param  {Array} messageIds Messages that are selected.\n     * @return {Object} New state with array of not blocked members.\n     */\n    var addSelectedMessagesById = function(state, messageIds) {\n        var newState = cloneState(state);\n        messageIds = messageIds.map(function(id) {\n            return \"\" + id;\n        });\n        newState.selectedMessageIds = newState.selectedMessageIds.concat(messageIds);\n        return newState;\n    };\n\n    /**\n     * Remove messages from the state selected messages.\n     *\n     * @param  {Object} state Current state.\n     * @param  {Array} messageIds Messages to remove from selected messages.\n     * @return {Object} New state with array of selected messages.\n     */\n    var removeSelectedMessagesById = function(state, messageIds) {\n        var newState = cloneState(state);\n        messageIds = messageIds.map(function(id) {\n            return \"\" + id;\n        });\n        newState.selectedMessageIds = newState.selectedMessageIds.filter(function(id) {\n            return messageIds.indexOf(id) < 0;\n        });\n        return newState;\n    };\n\n    /**\n     * Mark messages as read.\n     *\n     * @param  {Object} state Current state.\n     * @param  {Array} readMessages Messages that are read.\n     * @return {Object} New state with array of messages that have the isread attribute set.\n     */\n    var markMessagesAsRead = function(state, readMessages) {\n        var newState = cloneState(state);\n        var readMessageIds = readMessages.map(function(message) {\n            return message.id;\n        });\n        newState.messages = newState.messages.map(function(message) {\n            if (readMessageIds.indexOf(message.id) >= 0) {\n                message.isRead = true;\n            }\n\n            return message;\n        });\n        return newState;\n    };\n\n    /**\n     * Add a contact request to each of the members that the request is for.\n     *\n     * @param  {Object} state Current state.\n     * @param  {Array} requests The contact requests\n     * @return {Object} New state\n     */\n    var addContactRequests = function(state, requests) {\n        var newState = cloneState(state);\n\n        requests.forEach(function(request) {\n            var fromUserId = request.userid;\n            var toUserId = request.requesteduserid;\n            newState.members[fromUserId].contactrequests.push(request);\n            newState.members[toUserId].contactrequests.push(request);\n        });\n\n        return newState;\n    };\n\n    /**\n     * Remove a contact request from the members of that request.\n     *\n     * @param  {Object} state Current state.\n     * @param  {Array} requests The contact requests\n     * @return {Object} New state\n     */\n    var removeContactRequests = function(state, requests) {\n        var newState = cloneState(state);\n        requests.forEach(function(request) {\n            var fromUserId = request.userid;\n            var toUserId = request.requesteduserid;\n\n            newState.members[fromUserId].contactrequests = newState.members[fromUserId].contactrequests.filter(function(existing) {\n                return existing.userid != fromUserId;\n            });\n            newState.members[toUserId].contactrequests = newState.members[toUserId].contactrequests.filter(function(existing) {\n                return existing.requesteduserid != toUserId;\n            });\n        });\n\n        return newState;\n    };\n\n    /**\n     * Set wheter the message of the conversation can delete for all users.\n     *\n     * @param  {Object} state Current state.\n     * @param  {Bool} value If it can delete for all users.\n     * @return {Object} New state.\n     */\n    var setCanDeleteMessagesForAllUsers = function(state, value) {\n        var newState = cloneState(state);\n        newState.canDeleteMessagesForAllUsers = value;\n        return newState;\n    };\n\n    /**\n     * Set wheter the messages of the conversation delete for all users.\n     *\n     * @param  {Object} state Current state.\n     * @param  {Bool} value Delete messages for all users.\n     * @return {Object} New state.\n     */\n    var setDeleteMessagesForAllUsers = function(state, value) {\n        var newState = cloneState(state);\n        newState.deleteMessagesForAllUsers = value;\n        return newState;\n    };\n\n    return {\n        buildInitialState: buildInitialState,\n        addMessages: addMessages,\n        updateMessages: updateMessages,\n        removeMessages: removeMessages,\n        removeMessagesById: removeMessagesById,\n        addMembers: addMembers,\n        removeMembers: removeMembers,\n        setLoadingMessages: setLoadingMessages,\n        setLoadingMembers: setLoadingMembers,\n        setId: setId,\n        setName: setName,\n        setSubname: setSubname,\n        setType: setType,\n        setIsFavourite: setIsFavourite,\n        setIsMuted: setIsMuted,\n        setCanDeleteMessagesForAllUsers: setCanDeleteMessagesForAllUsers,\n        setDeleteMessagesForAllUsers: setDeleteMessagesForAllUsers,\n        setTotalMemberCount: setTotalMemberCount,\n        setImageUrl: setImageUrl,\n        setLoadingConfirmAction: setLoadingConfirmAction,\n        setPendingDeleteConversation: setPendingDeleteConversation,\n        setMessagesSendPendingById: setMessagesSendPendingById,\n        setMessagesSendSuccessById: setMessagesSendSuccessById,\n        setMessagesSendFailById: setMessagesSendFailById,\n        setShowEmojiAutoComplete: setShowEmojiAutoComplete,\n        setShowEmojiPicker: setShowEmojiPicker,\n        addPendingBlockUsersById: addPendingBlockUsersById,\n        addPendingRemoveContactsById: addPendingRemoveContactsById,\n        addPendingUnblockUsersById: addPendingUnblockUsersById,\n        addPendingAddContactsById: addPendingAddContactsById,\n        addPendingDeleteMessagesById: addPendingDeleteMessagesById,\n        removePendingBlockUsersById: removePendingBlockUsersById,\n        removePendingRemoveContactsById: removePendingRemoveContactsById,\n        removePendingUnblockUsersById: removePendingUnblockUsersById,\n        removePendingAddContactsById: removePendingAddContactsById,\n        removePendingDeleteMessagesById: removePendingDeleteMessagesById,\n        addSelectedMessagesById: addSelectedMessagesById,\n        removeSelectedMessagesById: removeSelectedMessagesById,\n        markMessagesAsRead: markMessagesAsRead,\n        addContactRequests: addContactRequests,\n        removeContactRequests: removeContactRequests\n    };\n});\n"],"names":["define","$","cloneState","state","extend","formatMessages","messages","loggedInUserId","members","map","message","fromLoggedInUser","useridfrom","id","userFrom","text","downloadUrl","downloadurl","attachment","timeCreated","timecreated","parseInt","buildInitialState","midnight","messagePollMin","messagePollMax","messagePollAfterMax","name","subname","type","totalMemberCount","imageUrl","isFavourite","isMuted","canDeleteMessagesForAllUsers","deleteMessagesForAllUsers","hasTriedToLoadMessages","loadingMessages","loadingMembers","loadingConfirmAction","pendingBlockUserIds","pendingUnblockUserIds","pendingRemoveContactIds","pendingAddContactIds","pendingDeleteMessageIds","pendingSendMessageIds","pendingDeleteConversation","selectedMessageIds","showEmojiAutoComplete","showEmojiPicker","addMessages","newState","formattedMessages","sendState","timeAdded","Date","now","errorMessage","allMessages","concat","sort","a","b","filter","index","sortedMessages","updateMessages","data","updatesById","reduce","carry","messageData","oldMessage","newMessage","formattedMessage","removeMessages","removeMessageIds","indexOf","removeMessagesById","messageIds","addMembers","formattedMembers","member","fullname","profileurl","profileimageurl","profileimageurlsmall","isonline","showonlinestatus","isblocked","iscontact","isdeleted","canmessage","canmessageevenifblocked","requirescontact","contactrequests","formatMembers","forEach","removeMembers","setLoadingMessages","value","setLoadingMembers","setId","setName","setSubname","setType","setIsFavourite","setIsMuted","setCanDeleteMessagesForAllUsers","setDeleteMessagesForAllUsers","setTotalMemberCount","count","setImageUrl","url","setLoadingConfirmAction","setPendingDeleteConversation","setMessagesSendPendingById","setMessagesSendSuccessById","setMessagesSendFailById","setShowEmojiAutoComplete","show","setShowEmojiPicker","addPendingBlockUsersById","userIds","push","addPendingRemoveContactsById","addPendingUnblockUsersById","addPendingAddContactsById","addPendingDeleteMessagesById","removePendingBlockUsersById","removePendingRemoveContactsById","removePendingUnblockUsersById","removePendingAddContactsById","removePendingDeleteMessagesById","addSelectedMessagesById","removeSelectedMessagesById","markMessagesAsRead","readMessages","readMessageIds","isRead","addContactRequests","requests","request","fromUserId","userid","toUserId","requesteduserid","removeContactRequests","existing"],"mappings":";;;;;;;;;;;;;;;;;AAgCAA,qEAAO,CAAC,WAAW,SAASC,OASpBC,WAAa,SAASC,cAKfF,EAAEG,QAAO,EAAM,GAAID,QAW1BE,eAAiB,SAASC,SAAUC,eAAgBC,gBAC7CF,SAASG,KAAI,SAASC,aACrBC,iBAAmBD,QAAQE,YAAcL,qBACtC,CAEHM,GAAI,GAAKH,QAAQG,GACjBF,iBAAkBA,iBAClBG,SAAUN,QAAQE,QAAQE,YAC1BG,KAAML,QAAQK,KACdC,YAAaN,QAAQO,YACrBC,WAAYR,QAAQQ,WACpBC,YAAaT,QAAQU,YAAcC,SAASX,QAAQU,YAAa,IAAM,gBAmwB5E,CACHE,kBAztBoB,SACpBC,SACAhB,eACAM,GACAW,eACAC,eACAC,2BAEO,CACHH,SAAUA,SACVhB,eAAgBA,eAChBM,GAAIA,GACJW,eAAgBA,eAChBC,eAAgBA,eAChBC,oBAAqBA,oBACrBC,KAAM,KACNC,QAAS,KACTC,KAAM,KACNC,iBAAkB,KAClBC,SAAU,KACVC,YAAa,KACbC,QAAS,KACTC,8BAA8B,EAC9BC,2BAA2B,EAC3B3B,QAAS,GACTF,SAAU,GACV8B,wBAAwB,EACxBC,iBAAiB,EACjBC,gBAAgB,EAChBC,sBAAsB,EACtBC,oBAAqB,GACrBC,sBAAuB,GACvBC,wBAAyB,GACzBC,qBAAsB,GACtBC,wBAAyB,GACzBC,sBAAuB,GACvBC,2BAA2B,EAC3BC,mBAAoB,GACpBC,uBAAuB,EACvBC,iBAAiB,IAmrBrBC,YAxqBc,SAAS/C,MAAOG,cAC1B6C,SAAWjD,WAAWC,OACtBiD,kBAAoB/C,eAAeC,SAAUH,MAAMI,eAAgBJ,MAAMK,SAC7E4C,kBAAoBA,kBAAkB3C,KAAI,SAASC,gBAC/CA,QAAQ2C,UAAY,KACpB3C,QAAQ4C,UAAYC,KAAKC,MACzB9C,QAAQ+C,aAAe,KAChB/C,eAEPgD,YAAcvD,MAAMG,SAASqD,OAAOP,0BAExCM,YAAYE,MAAK,SAASC,EAAGC,MACH,OAAlBD,EAAE1C,aAA0C,OAAlB2C,EAAE3C,YAAsB,IAC9C0C,EAAEP,UAAYQ,EAAER,iBACR,EACL,GAAIO,EAAEP,UAAYQ,EAAER,iBAChB,SAIO,OAAlBO,EAAE1C,aAA0C,OAAlB2C,EAAE3C,YAErB,EACkB,OAAlB0C,EAAE1C,aAA0C,OAAlB2C,EAAE3C,aAG5B0C,EAAE1C,YAAc2C,EAAE3C,aADjB,EAID0C,EAAE1C,YAAc2C,EAAE3C,YAElB,EACA0C,EAAEhD,GAAKiD,EAAEjD,IACR,EACDgD,EAAEhD,GAAKiD,EAAEjD,GACT,EAEA,KAKfsC,SAAS7C,SAAWoD,YAAYK,QAAO,SAASrD,QAASsD,MAAOC,uBACpDD,OAAStD,QAAQG,IAAMoD,eAAeD,MAAQ,GAAGnD,MAGtDsC,UA2nBPe,eAjnBiB,SAAS/D,MAAOgE,UAC7BhB,SAAWjD,WAAWC,OACtBiE,YAAcD,KAAKE,QAAO,SAASC,MAAOC,iBACtCC,WAAaD,YAAY,GACzBE,WAAaF,YAAY,GAEzBG,iBADoBrE,eAAe,CAACoE,YAAatE,MAAMI,eAAgBJ,MAAMK,SACxC,UAEzC8D,MAAME,WAAW3D,IAAM6D,iBAChBJ,QACR,WAEHnB,SAAS7C,SAAW6C,SAAS7C,SAASG,KAAI,SAASC,gBAC3CA,QAAQG,MAAMuD,YACPnE,EAAEG,OAAOM,QAAS0D,YAAY1D,QAAQG,KAEtCH,WAIRyC,UA8lBPwB,eAplBiB,SAASxE,MAAOG,cAC7B6C,SAAWjD,WAAWC,OACtByE,iBAAmBtE,SAASG,KAAI,SAASC,eAClC,GAAKA,QAAQG,aAExBsC,SAAS7C,SAAW6C,SAAS7C,SAASyD,QAAO,SAASrD,gBAC3CkE,iBAAiBC,QAAQnE,QAAQG,IAAM,KAG3CsC,UA4kBP2B,mBAlkBqB,SAAS3E,MAAO4E,gBACjC5B,SAAWjD,WAAWC,cAC1B4E,WAAaA,WAAWtE,KAAI,SAASI,UAC1B,GAAKA,MAEhBsC,SAAS7C,SAAW6C,SAAS7C,SAASyD,QAAO,SAASrD,gBAC3CqE,WAAWF,QAAQnE,QAAQG,IAAM,KAGrCsC,UA0jBP6B,WAhjBa,SAAS7E,MAAOK,aACzB2C,SAAWjD,WAAWC,OACtB8E,iBAhNY,SAASzE,gBAClBA,QAAQC,KAAI,SAASyE,cACjB,CACHrE,GAAIqE,OAAOrE,GACXsE,SAAUD,OAAOC,SACjBC,WAAYF,OAAOE,WACnBC,gBAAiBH,OAAOG,gBACxBC,qBAAsBJ,OAAOI,qBAC7BC,SAAWL,OAAOK,SAClBC,iBAAkBN,OAAOM,iBACzBC,UAAWP,OAAOO,UAClBC,UAAWR,OAAOQ,UAClBC,UAAWT,OAAOS,UAClBC,WAAYV,OAAOU,WACnBC,wBAAyBX,OAAOW,wBAChCC,gBAAiBZ,OAAOY,gBACxBC,gBAAiBb,OAAOa,iBAAmB,OAgM5BC,CAAcxF,gBACrCyE,iBAAiBgB,SAAQ,SAASf,QAC9B/B,SAAS3C,QAAQ0E,OAAOrE,IAAMqE,UAE3B/B,UA2iBP+C,cAjiBgB,SAAS/F,MAAOK,aAC5B2C,SAAWjD,WAAWC,cAC1BK,QAAQyF,SAAQ,SAASf,eACd/B,SAAS3C,QAAQ0E,OAAOrE,OAE5BsC,UA6hBPgD,mBAnhBqB,SAAShG,MAAOiG,WACjCjD,SAAWjD,WAAWC,cAC1BgD,SAASd,gBAAkB+D,MACvBjG,MAAMkC,kBAAoB+D,QAG1BjD,SAASf,wBAAyB,GAE/Be,UA4gBPkD,kBAlgBoB,SAASlG,MAAOiG,WAChCjD,SAAWjD,WAAWC,cAC1BgD,SAASb,eAAiB8D,MACnBjD,UAggBPmD,MAtfQ,SAASnG,MAAOiG,WACpBjD,SAAWjD,WAAWC,cAC1BgD,SAAStC,GAAKuF,MACPjD,UAofPoD,QA1eU,SAASpG,MAAOiG,WACtBjD,SAAWjD,WAAWC,cAC1BgD,SAASxB,KAAOyE,MACTjD,UAwePqD,WA9da,SAASrG,MAAOiG,WACzBjD,SAAWjD,WAAWC,cAC1BgD,SAASvB,QAAUwE,MACZjD,UA4dPsD,QAldU,SAAStG,MAAO0B,UACtBsB,SAAWjD,WAAWC,cAC1BgD,SAAStB,KAAOA,KACTsB,UAgdPuD,eAtciB,SAASvG,MAAO6B,iBAC7BmB,SAAWjD,WAAWC,cAC1BgD,SAASnB,YAAcA,YAChBmB,UAocPwD,WA1ba,SAASxG,MAAO8B,aACzBkB,SAAWjD,WAAWC,cAC1BgD,SAASlB,QAAUA,QACZkB,UAwbPyD,gCAnCkC,SAASzG,MAAOiG,WAC9CjD,SAAWjD,WAAWC,cAC1BgD,SAASjB,6BAA+BkE,MACjCjD,UAiCP0D,6BAvB+B,SAAS1G,MAAOiG,WAC3CjD,SAAWjD,WAAWC,cAC1BgD,SAAShB,0BAA4BiE,MAC9BjD,UAqBP2D,oBAhbsB,SAAS3G,MAAO4G,WAClC5D,SAAWjD,WAAWC,cAC1BgD,SAASrB,iBAAmBiF,MACrB5D,UA8aP6D,YApac,SAAS7G,MAAO8G,SAC1B9D,SAAWjD,WAAWC,cAC1BgD,SAASpB,SAAWkF,IACb9D,UAkaP+D,wBAxZ0B,SAAS/G,MAAOiG,WACtCjD,SAAWjD,WAAWC,cAC1BgD,SAASZ,qBAAuB6D,MACzBjD,UAsZPgE,6BA5Y+B,SAAShH,MAAOiG,WAC3CjD,SAAWjD,WAAWC,cAC1BgD,SAASL,0BAA4BsD,MAC9BjD,UA0YPiE,2BAhY6B,SAASjH,MAAO4E,gBACzC5B,SAAWjD,WAAWC,cAC1B4E,WAAaA,WAAWtE,KAAI,SAASI,UAC1B,GAAKA,MAEhBsC,SAAS7C,SAAS2F,SAAQ,SAASvF,SAC3BqE,WAAWF,QAAQnE,QAAQG,KAAO,IAClCH,QAAQ2C,UAAY,UACpB3C,QAAQ+C,aAAe,SAGxBN,UAsXPkE,2BA5W6B,SAASlH,MAAO4E,gBACzC5B,SAAWjD,WAAWC,cAC1B4E,WAAaA,WAAWtE,KAAI,SAASI,UAC1B,GAAKA,MAEhBsC,SAAS7C,SAAS2F,SAAQ,SAASvF,SAC3BqE,WAAWF,QAAQnE,QAAQG,KAAO,IAClCH,QAAQ2C,UAAY,OACpB3C,QAAQ+C,aAAe,SAGxBN,UAkWPmE,wBAvV0B,SAASnH,MAAO4E,WAAYtB,kBAClDN,SAAWjD,WAAWC,cAC1B4E,WAAaA,WAAWtE,KAAI,SAASI,UAC1B,GAAKA,MAEhBsC,SAAS7C,SAAS2F,SAAQ,SAASvF,SAC3BqE,WAAWF,QAAQnE,QAAQG,KAAO,IAClCH,QAAQ2C,UAAY,QACpB3C,QAAQ+C,aAAeA,iBAGxBN,UA6UPoE,yBAtT2B,SAASpH,MAAOqH,UACvCrE,SAAWjD,WAAWC,cAC1BgD,SAASH,sBAAwBwE,KAC1BrE,UAoTPsE,mBApUqB,SAAStH,MAAOqH,UACjCrE,SAAWjD,WAAWC,cAC1BgD,SAASF,gBAAkBuE,KACpBrE,UAkUPuE,yBA3S2B,SAASvH,MAAOwH,aACvCxE,SAAWjD,WAAWC,cAC1BwH,QAAQ1B,SAAQ,SAASpF,IACrBsC,SAASX,oBAAoBoF,KAAK/G,OAE/BsC,UAuSP0E,6BA7R+B,SAAS1H,MAAOwH,aAC3CxE,SAAWjD,WAAWC,cAC1BwH,QAAQ1B,SAAQ,SAASpF,IACrBsC,SAAST,wBAAwBkF,KAAK/G,OAEnCsC,UAyRP2E,2BA/Q6B,SAAS3H,MAAOwH,aACzCxE,SAAWjD,WAAWC,cAC1BwH,QAAQ1B,SAAQ,SAASpF,IACrBsC,SAASV,sBAAsBmF,KAAK/G,OAEjCsC,UA2QP4E,0BAjQ4B,SAAS5H,MAAOwH,aACxCxE,SAAWjD,WAAWC,cAC1BwH,QAAQ1B,SAAQ,SAASpF,IACrBsC,SAASR,qBAAqBiF,KAAK/G,OAEhCsC,UA6PP6E,6BAnP+B,SAAS7H,MAAO4E,gBAC3C5B,SAAWjD,WAAWC,cAC1B4E,WAAWkB,SAAQ,SAASpF,IACxBsC,SAASP,wBAAwBgF,KAAK/G,OAEnCsC,UA+OP8E,4BArO8B,SAAS9H,MAAOwH,aAC1CxE,SAAWjD,WAAWC,cAC1BgD,SAASX,oBAAsBW,SAASX,oBAAoBuB,QAAO,SAASlD,WACjE8G,QAAQ9C,QAAQhE,IAAM,KAE1BsC,UAiOP+E,gCAvNkC,SAAS/H,MAAOwH,aAC9CxE,SAAWjD,WAAWC,cAC1BgD,SAAST,wBAA0BS,SAAST,wBAAwBqB,QAAO,SAASlD,WACzE8G,QAAQ9C,QAAQhE,IAAM,KAE1BsC,UAmNPgF,8BAzMgC,SAAShI,MAAOwH,aAC5CxE,SAAWjD,WAAWC,cAC1BgD,SAASV,sBAAwBU,SAASV,sBAAsBsB,QAAO,SAASlD,WACrE8G,QAAQ9C,QAAQhE,IAAM,KAE1BsC,UAqMPiF,6BA3L+B,SAASjI,MAAOwH,aAC3CxE,SAAWjD,WAAWC,cAC1BgD,SAASR,qBAAuBQ,SAASR,qBAAqBoB,QAAO,SAASlD,WACnE8G,QAAQ9C,QAAQhE,IAAM,KAE1BsC,UAuLPkF,gCA7KkC,SAASlI,MAAO4E,gBAC9C5B,SAAWjD,WAAWC,cAC1B4E,WAAaA,WAAWtE,KAAI,SAASI,UAC1B,GAAKA,MAEhBsC,SAASP,wBAA0BO,SAASP,wBAAwBmB,QAAO,SAASlD,WACzEkE,WAAWF,QAAQhE,IAAM,KAE7BsC,UAsKPmF,wBA5J0B,SAASnI,MAAO4E,gBACtC5B,SAAWjD,WAAWC,cAC1B4E,WAAaA,WAAWtE,KAAI,SAASI,UAC1B,GAAKA,MAEhBsC,SAASJ,mBAAqBI,SAASJ,mBAAmBY,OAAOoB,YAC1D5B,UAuJPoF,2BA7I6B,SAASpI,MAAO4E,gBACzC5B,SAAWjD,WAAWC,cAC1B4E,WAAaA,WAAWtE,KAAI,SAASI,UAC1B,GAAKA,MAEhBsC,SAASJ,mBAAqBI,SAASJ,mBAAmBgB,QAAO,SAASlD,WAC/DkE,WAAWF,QAAQhE,IAAM,KAE7BsC,UAsIPqF,mBA5HqB,SAASrI,MAAOsI,kBACjCtF,SAAWjD,WAAWC,OACtBuI,eAAiBD,aAAahI,KAAI,SAASC,gBACpCA,QAAQG,aAEnBsC,SAAS7C,SAAW6C,SAAS7C,SAASG,KAAI,SAASC,gBAC3CgI,eAAe7D,QAAQnE,QAAQG,KAAO,IACtCH,QAAQiI,QAAS,GAGdjI,WAEJyC,UAiHPyF,mBAvGqB,SAASzI,MAAO0I,cACjC1F,SAAWjD,WAAWC,cAE1B0I,SAAS5C,SAAQ,SAAS6C,aAClBC,WAAaD,QAAQE,OACrBC,SAAWH,QAAQI,gBACvB/F,SAAS3C,QAAQuI,YAAYhD,gBAAgB6B,KAAKkB,SAClD3F,SAAS3C,QAAQyI,UAAUlD,gBAAgB6B,KAAKkB,YAG7C3F,UA8FPgG,sBApFwB,SAAShJ,MAAO0I,cACpC1F,SAAWjD,WAAWC,cAC1B0I,SAAS5C,SAAQ,SAAS6C,aAClBC,WAAaD,QAAQE,OACrBC,SAAWH,QAAQI,gBAEvB/F,SAAS3C,QAAQuI,YAAYhD,gBAAkB5C,SAAS3C,QAAQuI,YAAYhD,gBAAgBhC,QAAO,SAASqF,iBACjGA,SAASJ,QAAUD,cAE9B5F,SAAS3C,QAAQyI,UAAUlD,gBAAkB5C,SAAS3C,QAAQyI,UAAUlD,gBAAgBhC,QAAO,SAASqF,iBAC7FA,SAASF,iBAAmBD,eAIpC9F"}