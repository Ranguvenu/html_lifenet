{"version":3,"file":"issues-list.min.js","sources":["../src/issues-list.js"],"sourcesContent":["// This file is part of the tool_certificate plugin for Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * AMD module used when viewing the list of issued certificates\n *\n * @module     tool_certificate/issues-list\n * @copyright  2019 Marina Glancy\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport Notification from 'core/notification';\nimport {get_strings as getStrings, get_string as getString} from 'core/str';\nimport Ajax from 'core/ajax';\nimport ModalForm from 'core_form/modalform';\nimport {add as toastAdd} from 'core/toast';\nimport {refreshTableContent, getFilters, setFilters} from 'core_table/dynamic';\nimport * as DynamicTableSelectors from 'core_table/local/dynamic/selectors';\nimport Pending from 'core/pending';\n\nconst SELECTORS = {\n    ADDISSUE: \"[data-element='addbutton']\",\n    REGENERATEFILE: \"[data-action='regenerate']\",\n    REVOKEISSUE: \"[data-action='revoke']\",\n    GROUPFORM: \".groupselector form\",\n    GROUPSELECTOR: \"select[name='group']\",\n    EDITISSUE: \"[data-action='edit']\",\n};\n\n/**\n * Add issue dialogue\n * @param {Element} element\n */\nconst addIssue = function(element) {\n    const modal = new ModalForm({\n        formClass: 'tool_certificate\\\\form\\\\certificate_issues',\n        args: {tid: element.dataset.tid},\n        modalConfig: {title: getString('issuecertificates', 'tool_certificate'), scrollable: false},\n        saveButtonText: getString('save'),\n        returnFocus: element,\n    });\n    modal.addEventListener(modal.events.FORM_SUBMITTED, event => {\n        const issuescreated = parseInt(event.detail, 10);\n        if (issuescreated > 1) {\n            toastAdd(getString('aissueswerecreated', 'tool_certificate', issuescreated));\n            reloadReport();\n        } else if (issuescreated === 1) {\n            toastAdd(getString('oneissuewascreated', 'tool_certificate'));\n            reloadReport();\n        } else {\n            toastAdd(getString('noissueswerecreated', 'tool_certificate'));\n        }\n    });\n    modal.show();\n};\n/**\n * Add issue dialogue\n * @param {Element} element\n */\nconst editIssue = function(element) {\n    const modal = new ModalForm({\n        formClass: 'tool_certificate\\\\form\\\\certificate_issues',\n        args: {tid: element.dataset.tid, id: element.dataset.id},\n        modalConfig: {title: getString('issuecertificates', 'tool_certificate'), scrollable: false},\n        saveButtonText: getString('save'),\n        returnFocus: element,\n    });\n    modal.addEventListener(modal.events.FORM_SUBMITTED, () => {\n        toastAdd(getString('certificateupdated', 'tool_certificate'));\n        reloadReport();\n    });\n    modal.show();\n};\n\n/**\n * Revoke issue\n * @param {Element} element\n */\nconst revokeIssue = function(element) {\n    let pendingPromise;\n    const triggerElement = element.closest('.dropdown').querySelector('.dropdown-toggle');\n    getStrings([\n        {key: 'confirm', component: 'moodle'},\n        {key: 'revokecertificateconfirm', component: 'tool_certificate'},\n        {key: 'revoke', component: 'tool_certificate'},\n    ]).then(([title, question, saveLabel]) => {\n        return Notification.saveCancelPromise(title, question, saveLabel, {triggerElement});\n    }).then(() => {\n        pendingPromise = new Pending('tool_certificate/revokeIssue');\n        return Ajax.call([\n            {methodname: 'tool_certificate_revoke_issue', args: {id: element.dataset.id}}\n        ])[0];\n    }).then(() => {\n        reloadReport();\n        return pendingPromise.resolve();\n    }).catch((e) => {\n        if (e.type === 'modal-save-cancel:cancel') {\n            // Clicked cancel.\n            return;\n        }\n        Notification.exception(e);\n    });\n};\n\n/**\n * Revoke issue\n * @param {Element} element\n */\nconst regenerateIssueFile = function(element) {\n    const triggerElement = element.closest('.dropdown').querySelector('.dropdown-toggle');\n    getStrings([\n        {key: 'confirm', component: 'moodle'},\n        {key: 'regeneratefileconfirm', component: 'tool_certificate'},\n        {key: 'regenerate', component: 'tool_certificate'},\n    ]).then(([title, question, saveLabel]) => {\n        return Notification.saveCancelPromise(title, question, saveLabel, {triggerElement});\n    }).then(() => {\n        return Ajax.call([\n            {methodname: 'tool_certificate_regenerate_issue_file', args: {id: element.dataset.id}}\n        ]);\n    }).then(() => {\n        return reloadReport();\n    }).catch((e) => {\n        if (e.type === 'modal-save-cancel:cancel') {\n            // Clicked cancel.\n            return;\n        }\n        Notification.exception(e);\n    });\n};\n\n/**\n * Reload report\n * @returns {Promise}\n */\nvar reloadReport = function() {\n    const report = document.querySelector(DynamicTableSelectors.main.region);\n    return refreshTableContent(report).catch(Notification.exception);\n};\n\n/**\n * Change group and refresh table\n * @param {Event} e\n */\nconst changeGroup = function(e) {\n    const report = document.querySelector(DynamicTableSelectors.main.region);\n    let filters = getFilters(report);\n    let params = JSON.parse(filters.filters.parameters.values[0]);\n    params.groupid = e.target.value;\n    filters.filters.parameters.values[0] = JSON.stringify(params);\n    setFilters(report, filters);\n};\n\n/**\n * Init page\n */\nexport function init() {\n    document.addEventListener('click', event => {\n\n        // Add issue.\n        const addIssueElement = event.target.closest(SELECTORS.ADDISSUE);\n        if (addIssueElement) {\n            event.preventDefault();\n            addIssue(addIssueElement);\n        }\n\n        // Add issue.\n        const editIssueElement = event.target.closest(SELECTORS.EDITISSUE);\n        if (editIssueElement) {\n            event.preventDefault();\n            editIssue(editIssueElement);\n        }\n\n        // Revoke issue.\n        const revokeIssueElement = event.target.closest(SELECTORS.REVOKEISSUE);\n        if (revokeIssueElement) {\n            event.preventDefault();\n            revokeIssue(revokeIssueElement);\n        }\n\n        // Regenerate file.\n        const regenerateFileElement = event.target.closest(SELECTORS.REGENERATEFILE);\n        if (regenerateFileElement) {\n            event.preventDefault();\n            regenerateIssueFile(regenerateFileElement);\n        }\n    });\n\n    const groupform = document.querySelector(SELECTORS.GROUPFORM);\n    if (groupform) {\n        // Flush existing event listeners.\n        const node = groupform.cloneNode(true);\n        groupform.replaceWith(node);\n        // Add event handler.\n        node.querySelector(SELECTORS.GROUPSELECTOR).addEventListener('change', changeGroup);\n    }\n}\n"],"names":["_getRequireWildcardCache","nodeInterop","WeakMap","cacheBabelInterop","cacheNodeInterop","_interopRequireDefault","obj","__esModule","default","document","addEventListener","event","addIssueElement","target","closest","SELECTORS","ADDISSUE","preventDefault","addIssue","editIssueElement","EDITISSUE","editIssue","revokeIssueElement","REVOKEISSUE","revokeIssue","regenerateFileElement","REGENERATEFILE","regenerateIssueFile","groupform","querySelector","GROUPFORM","node","cloneNode","replaceWith","GROUPSELECTOR","changeGroup","_notification","_ajax","_modalform","DynamicTableSelectors","cache","has","get","newObj","hasPropertyDescriptor","Object","defineProperty","getOwnPropertyDescriptor","key","prototype","hasOwnProperty","call","desc","set","_interopRequireWildcard","_pending","element","modal","ModalForm","formClass","args","tid","dataset","modalConfig","title","getString","scrollable","saveButtonText","returnFocus","events","FORM_SUBMITTED","issuescreated","parseInt","detail","toastAdd","reloadReport","show","id","pendingPromise","triggerElement","getStrings","component","then","_ref","question","saveLabel","Notification","saveCancelPromise","Pending","Ajax","methodname","resolve","catch","e","type","exception","_ref2","report","main","region","refreshTableContent","filters","getFilters","params","JSON","parse","parameters","values","groupid","value","stringify","setFilters"],"mappings":"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"}