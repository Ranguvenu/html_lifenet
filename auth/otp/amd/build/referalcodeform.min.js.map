{"version":3,"file":"referalcodeform.min.js","sources":["../src/referalcodeform.js"],"sourcesContent":["/**\r\n * Add a create new group modal to the page.\r\n *\r\n * @module     auth_otp/otp\r\n * @class      NewInstitute\r\n * @package    auth_otp\r\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\r\n */\r\ndefine(['jquery', 'core/str', 'core/modal_factory', 'core/modal_events', 'core/fragment', 'core/ajax', 'core/yui', 'core/notification'],\r\n        function($, Str, ModalFactory, ModalEvents, Fragment, Ajax, Y,Notification) {\r\n\r\n    /**\r\n     * Constructor\r\n     *\r\n     * @param {String} selector used to find triggers for the new group modal.\r\n     * @param {int} contextid\r\n     *\r\n     * Each call to init gets it's own instance of this class.\r\n     */\r\n    var NewReferalcode = function(args) {\r\n        this.contextid = args.contextid;\r\n\r\n        var self = this;\r\n        self.init(args.selector);\r\n    };\r\n\r\n    /**\r\n     * @var {Modal} modal\r\n     * @private\r\n     */\r\n    NewReferalcode.prototype.modal = null;\r\n\r\n    /**\r\n     * @var {int} contextid\r\n     * @private\r\n     */\r\n    NewReferalcode.prototype.contextid = -1;\r\n\r\n    /**\r\n     * Initialise the class.\r\n     *\r\n     * @param {String} selector used to find triggers for the new group modal.\r\n     * @private\r\n     * @return {Promise}\r\n     */\r\n    NewReferalcode.prototype.init = function(args) {\r\n        var self = this;\r\n\r\n        var head =  {key:'referalcodeheader', component:'auth_otp'};\r\n\r\n        customstrings = Str.get_strings([head,{\r\n                key: 'referalcodeheader',\r\n                component: 'auth_otp'\r\n            },\r\n            {\r\n                key: 'apply',\r\n                component: 'auth_otp'\r\n            },\r\n            {\r\n                key: 'skip',\r\n                component: 'auth_otp'\r\n            }]);\r\n\r\n        return customstrings.then(function(strings) {\r\n                return ModalFactory.create({\r\n                    type: ModalFactory.types.DEFAULT,\r\n                    title: strings[0],\r\n                    body: self.getBody(),\r\n                    footer: self.getFooter(strings),\r\n                });\r\n            }.bind(this)).then(function(modal) {\r\n            // Keep a reference to the modal.\r\n            this.modal = modal;\r\n\r\n            this.modal.getFooter().find('[data-action=\"save\"]').on('click', this.submitForm.bind(this));\r\n            this.modal.getFooter().find('[data-action=\"cancel\"]').on('click', function() {\r\n                params = {};\r\n                params.contextid = 1;\r\n                params.status = 1;\r\n                var promise = Ajax.call([{\r\n                    methodname: 'auth_otp_alter_popup_status',\r\n                    args: params\r\n                }]);\r\n                promise[0].done(function(resp) {\r\n                    window.location.href =  window.location.href;\r\n                }).fail(function(ex) {\r\n                     console.log(ex);\r\n                });\r\n\r\n            });\r\n            // added for custom navigating from the top lists ends here.\r\n            this.modal.getRoot().on('submit', 'form', function(form) {\r\n                self.submitFormAjax(form, self.args);\r\n            });\r\n            this.modal.show();\r\n            this.modal.getRoot().animate({\"right\":\"0%\"}, 500);\r\n            $(\".close\").click(function(){\r\n                params = {};\r\n                params.contextid = 1;\r\n                params.status = 1;\r\n                var promise = Ajax.call([{\r\n                    methodname: 'auth_otp_alter_popup_status',\r\n                    args: params\r\n                }]);\r\n                promise[0].done(function(resp) {\r\n                    window.location.href =  window.location.href;\r\n                }).fail(function(ex) {\r\n                     console.log(ex);\r\n                });\r\n            });\r\n            return this.modal;\r\n        }.bind(this));\r\n\r\n    };\r\n\r\n    /**\r\n     * @method getBody\r\n     * @private\r\n     * @return {Promise}\r\n     */\r\n    NewReferalcode.prototype.getBody = function(formdata) {\r\n        if (typeof formdata === \"undefined\") {\r\n            formdata = {};\r\n        }\r\n        // alert(formdata);\r\n        // Get the content of the modal.\r\n        var params = {jsonformdata: JSON.stringify(formdata)};\r\n        return Fragment.loadFragment('auth_otp', 'referalcode_form', this.contextid, params);\r\n    };\r\n    /**\r\n     * @method getFooter\r\n     * @private\r\n     * @return {Promise}\r\n     */\r\n    NewReferalcode.prototype.getFooter = function(customstrings) {\r\n\r\n        var footer = '';\r\n\r\n        var style = 'style=\"display:none;\"';\r\n\r\n        footer += '<button type=\"button\" class=\"btn btn-primary\" data-action=\"save\">'+customstrings[2]+'</button>&nbsp;';\r\n\r\n        footer += '<button type=\"button\" class=\"btn btn-secondary\" data-action=\"cancel\">'+customstrings[3]+'</button>';\r\n        return footer;\r\n\r\n    };\r\n\r\n    /**\r\n     * @method handleFormSubmissionResponse\r\n     * @private\r\n     * @return {Promise}\r\n     */\r\n    NewReferalcode.prototype.handleFormSubmissionResponse = function() {\r\n        this.modal.hide();\r\n        // We could trigger an event instead.\r\n        // Yuk.\r\n        Y.use('moodle-core-formchangechecker', function() {\r\n            M.core_formchangechecker.reset_form_dirty_state();\r\n        });\r\n        Notification.addNotification({\r\n            message: 'Referral code successfully applied.',\r\n            type: 'success'\r\n        });\r\n    };\r\n\r\n    /**\r\n     * @method handleFormSubmissionFailure\r\n     * @private\r\n     * @return {Promise}\r\n     */\r\n    NewReferalcode.prototype.handleFormSubmissionFailure = function(data) {\r\n        // Oh noes! Epic fail :(\r\n        // Ah wait - this is normal. We need to re-display the form with errors!\r\n        this.modal.setBody(this.getBody(data));\r\n    };\r\n\r\n    /**\r\n     * Private method\r\n     *\r\n     * @method submitFormAjax\r\n     * @private\r\n     * @param {Event} e Form submission event.\r\n     */\r\n    NewReferalcode.prototype.submitFormAjax = function(e) {\r\n        // We don't want to do a real form submission.\r\n        e.preventDefault();\r\n\r\n        // Convert all the form elements values to a serialised string.\r\n        var formData = this.modal.getRoot().find('form').serialize();\r\n        // alert(this.contextid);\r\n        // Now we can continue...\r\n        Ajax.call([{\r\n            methodname: 'auth_otp_submit_referalcode',\r\n            args: {contextid: this.contextid, jsonformdata: JSON.stringify(formData)},\r\n            done: this.handleFormSubmissionResponse.bind(this, formData),\r\n            fail: this.handleFormSubmissionFailure.bind(this, formData)\r\n        }]);\r\n    };\r\n\r\n    /**\r\n     * This triggers a form submission, so that any mform elements can do final tricks before the form submission is processed.\r\n     *\r\n     * @method submitForm\r\n     * @param {Event} e Form submission event.\r\n     * @private\r\n     */\r\n    NewReferalcode.prototype.submitForm = function(e) {\r\n        e.preventDefault();\r\n        var self = this;\r\n        self.modal.getRoot().find('form').submit();\r\n    };\r\n\r\n    return /** @alias module:auth_otp/newotp */ {\r\n        // Public variables and functions.\r\n        /**\r\n         * Attach event listeners to initialise this module.\r\n         *\r\n         * @method init\r\n         * @param {string} selector The CSS selector used to find nodes that will trigger this module.\r\n         * @param {int} contextid The contextid for the course.\r\n         * @return {Promise}\r\n         */\r\n        init: function(args) {\r\n\r\n            return new NewReferalcode(args);\r\n        }\r\n    };\r\n});"],"names":["define","$","Str","ModalFactory","ModalEvents","Fragment","Ajax","Y","Notification","NewReferalcode","args","contextid","this","init","selector","prototype","modal","self","customstrings","get_strings","key","component","then","strings","create","type","types","DEFAULT","title","body","getBody","footer","getFooter","bind","find","on","submitForm","params","status","call","methodname","done","resp","window","location","href","fail","ex","console","log","getRoot","form","submitFormAjax","show","animate","click","formdata","jsonformdata","JSON","stringify","loadFragment","handleFormSubmissionResponse","hide","use","M","core_formchangechecker","reset_form_dirty_state","addNotification","message","handleFormSubmissionFailure","data","setBody","e","preventDefault","formData","serialize","submit"],"mappings":"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"}