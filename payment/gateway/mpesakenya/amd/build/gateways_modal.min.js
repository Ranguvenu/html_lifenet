define("paygw_mpesakenya/gateways_modal",["exports","jquery","./repository","core/ajax","core/config","core/log","core/modal_factory","core/modal_events","core/templates","core/str"],(function(_exports,_jquery,Repository,_ajax,_config,_log,_modal_factory,_modal_events,_templates,_str){function _getRequireWildcardCache(nodeInterop){if("function"!=typeof WeakMap)return null;var cacheBabelInterop=new WeakMap,cacheNodeInterop=new WeakMap;return(_getRequireWildcardCache=function(nodeInterop){return nodeInterop?cacheNodeInterop:cacheBabelInterop})(nodeInterop)}function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}
/**
   * This module is responsible for MPEsa Kenya content in the gateways modal.
   *
   * @copyright  2023 Medical Access Uganda Limited
   * @author     Renaat Debleu <info@eWallah.net>
   * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.process=void 0,_jquery=_interopRequireDefault(_jquery),Repository=function(obj,nodeInterop){if(!nodeInterop&&obj&&obj.__esModule)return obj;if(null===obj||"object"!=typeof obj&&"function"!=typeof obj)return{default:obj};var cache=_getRequireWildcardCache(nodeInterop);if(cache&&cache.has(obj))return cache.get(obj);var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj)if("default"!==key&&Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;desc&&(desc.get||desc.set)?Object.defineProperty(newObj,key,desc):newObj[key]=obj[key]}newObj.default=obj,cache&&cache.set(obj,newObj);return newObj}(Repository),_ajax=_interopRequireDefault(_ajax),_config=_interopRequireDefault(_config),_log=_interopRequireDefault(_log),_modal_factory=_interopRequireDefault(_modal_factory),_modal_events=_interopRequireDefault(_modal_events),_templates=_interopRequireDefault(_templates);const showModalWithPlaceholder=async mpesaConfig=>{console.table(mpesaConfig);const modal=await _modal_factory.default.create({body:await _templates.default.render("paygw_mpesakenya/placeholder",mpesaConfig)});return modal.show(),modal};_exports.process=(component,paymentArea,itemId,description)=>Promise.all([Repository.getConfigForJs(component,paymentArea,itemId)]).then((_ref=>{let[mpesaConfig]=_ref;return console.log(mpesaConfig),Promise.all([showModalWithPlaceholder(mpesaConfig)]).then((_ref2=>{let[modal]=_ref2;return modal.setTitle((0,_str.get_string)("pluginname","paygw_mpesakenya")),modal.getRoot().on(_modal_events.default.hidden,(()=>{modal.destroy()})),Promise.all([modal,mpesaConfig])}))})).then((_ref3=>{let[modal,mpesaConfig]=_ref3;var cancelButton=modal.getRoot().find("#mpesa-cancel");cancelButton.on("click",(function(){modal.destroy()}));var payButton=modal.getRoot().find("#mpesa-pay");return payButton.removeAttr("disabled"),payButton.on("click",(function(e){e.preventDefault();var phone="other"==(0,_jquery.default)("input[name='mpesanumber']:checked").val()?(0,_jquery.default)("input[name='mobilenumber']").val():mpesaConfig.phone;Promise.all([Repository.transactionStart(component,paymentArea,itemId,phone)]).then((_ref4=>{let[mpesaPay]=_ref4;const merchantrequestid=mpesaPay.merchantrequestid;modal.setBody(_templates.default.render("paygw_mpesakenya/busy",{sesskey:_config.default.sesskey,phone:mpesaConfig.phone,country:mpesaConfig.country,component:component,paymentarea:paymentArea,merchantrequestid:merchantrequestid,itemid:itemId,description:description,reference:mpesaConfig.reference})),(cancelButton=modal.getRoot().find("#mpesa-cancel")).on("click",(function(){e.preventDefault(),modal.destroy()})),(payButton=modal.getRoot().find("#mpesa-pay")).on("click",(function(){modal.destroy()})),payButton.attr("disabled",!0);var interval=mpesaConfig.timeout,cont=!0;const b="</div>";return[1,2,3,4,5,6,7,8,9,10].forEach((function(el,index){setTimeout((function(){if(1==cont){var progressDiv=modal.getRoot().find("#mpesa-progress_bar");progressDiv.attr("value",10*el),""!=mpesaPay.xreferenceid&&(_ajax.default.call([{methodname:"paygw_mpesakenya_transaction_complete",args:{component:component,paymentarea:paymentArea,itemid:itemId,merchantrequestid:merchantrequestid},done:function(mpesaPing){modal.setFooter(el+"/10 "+mpesaPing.message);var spinnerDiv=modal.getRoot().find("#mpesa-spinner");if(!mpesaPing.success){cont=!1;const a='<br/><div class="p-3 mb-2 bg-danger text-white font-weight-bold">';return modal.getRoot().find("#mpesa-out").append(a+mpesaPing.message+b),void spinnerDiv.attr("style","display: none;")}if("SUCCESSFUL"==mpesaPing.message){cont=!1,progressDiv.attr("value",100),spinnerDiv.attr("style","display: none;"),modal.getRoot().find("#mpesa-cancel").attr("style","display: none;");var payButton=modal.getRoot().find("#mpesa-pay");payButton.removeAttr("disabled"),modal.setFooter("Transaction "+merchantrequestid+" Succes"),payButton.on("click",(function(){const loc=window.location.href;window.location.replace(loc)}))}if("ERROR"==mpesaPing.message){cont=!1;const a='<br/><div class="p-3 mb-2 bg-danger text-white font-weight-bold">';return modal.getRoot().find("#mpesa-out").append(a+mpesaPing.desc+b),void spinnerDiv.attr("style","display: none;")}},fail:function(e){console.log((0,_str.get_string)("failed","paygw_mpesakenya")),_log.default.debug(e)}}]),el>9&&modal.destroy())}}),index*interval)})),new Promise((()=>null))})).catch((function(res){console.log(res),modal.setBody((0,_str.get_string)("unable","paygw_mpesakenya")),console.log("Unable to connect to MPesa")}))})),new Promise((()=>null))})).catch((e=>(_log.default.debug("Global error."),_log.default.debug(e),Promise.reject(e.message))))}));

//# sourceMappingURL=gateways_modal.min.js.map