{"version":3,"file":"gateways_modal.min.js","sources":["../src/gateways_modal.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * This module is responsible for MPEsa Kenya content in the gateways modal.\n *\n * @copyright  2023 Medical Access Uganda Limited\n * @author     Renaat Debleu <info@eWallah.net>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\nimport $ from 'jquery';\nimport * as Repository from './repository';\nimport Ajax from 'core/ajax';\nimport Config from 'core/config';\nimport Log from 'core/log';\nimport ModalFactory from 'core/modal_factory';\nimport ModalEvents from 'core/modal_events';\nimport Templates from 'core/templates';\nimport {get_string as getString} from 'core/str';\n\n/**\n * Creates and shows a modal that contains a placeholder.\n *\n * @param {mpesaConfig} mpesaConfig\n *\n * @returns {Promise<Modal>}\n */\nconst showModalWithPlaceholder = async(mpesaConfig) => {\n    console.table(mpesaConfig);\n    const modal = await ModalFactory.create({\n        body: await Templates.render('paygw_mpesakenya/placeholder', mpesaConfig)\n    });\n    modal.show();\n    return modal;\n};\n\n/**\n * Process the payment.\n *\n * @param {string} component Name of the component that the itemId belongs to\n * @param {string} paymentArea The area of the component that the itemId belongs to\n * @param {number} itemId An internal identifier that is used by the component\n * @param {string} description Description of the payment\n * @returns {Promise<string>}\n */\nexport const process = (component, paymentArea, itemId, description) => {\n    return Promise.all([\n        Repository.getConfigForJs(component, paymentArea, itemId),\n    ])\n    .then(([mpesaConfig]) => {        \n        // const modal = await showModalWithPlaceholder(mpesaConfig);\n        console.log(mpesaConfig);\n        return Promise.all([\n        showModalWithPlaceholder(mpesaConfig),\n    ])\n    .then(([modal]) => {        \n        modal.setTitle(getString('pluginname', 'paygw_mpesakenya'));      \n        // const userCountry = modal.getRoot().find('#mpesa-country');\n        // userCountry.append('<h4>' + mpesaConfig.usercountry + '</h4>');\n        // const extraDiv = modal.getRoot().find('#mpesa-extra');\n        // extraDiv.append('<h4>' + mpesaConfig.cost + ' ' + mpesaConfig.currency + '</h4>');\n        modal.getRoot().on(ModalEvents.hidden, () => {\n            // Destroy when hidden.\n            modal.destroy();\n        });\n        return Promise.all([modal, mpesaConfig]);\n    });\n        \n    })\n    .then(([modal, mpesaConfig]) => {\n        var cancelButton = modal.getRoot().find('#mpesa-cancel');\n        cancelButton.on('click', function() {\n            modal.destroy();\n        });\n        var payButton = modal.getRoot().find('#mpesa-pay');\n        payButton.removeAttr('disabled');\n        payButton.on('click', function(e) {\n            e.preventDefault();\n            var radioval = $(\"input[name='mpesanumber']:checked\").val();\n            var phone = (radioval =='other')? $(\"input[name='mobilenumber']\").val() : mpesaConfig.phone;\n            Promise.all([\n                Repository.transactionStart(component, paymentArea, itemId, phone),\n            ])\n            .then(([mpesaPay]) => {\n                const merchantrequestid = mpesaPay.merchantrequestid;\n                modal.setBody(Templates.render('paygw_mpesakenya/busy', {\n                    \"sesskey\": Config.sesskey,\n                    \"phone\": mpesaConfig.phone,\n                    \"country\": mpesaConfig.country,\n                    \"component\": component,\n                    \"paymentarea\": paymentArea,\n                    \"merchantrequestid\": merchantrequestid,\n                    \"itemid\": itemId,\n                    \"description\": description,\n                    \"reference\": mpesaConfig.reference,\n                }));\n                cancelButton = modal.getRoot().find('#mpesa-cancel');\n                cancelButton.on('click', function() {\n                    e.preventDefault();\n                    modal.destroy();\n                });\n                payButton = modal.getRoot().find('#mpesa-pay');\n                payButton.on('click', function() {\n                    modal.destroy();\n                });\n                payButton.attr('disabled', true);\n                var arrayints = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10];\n                var interval = mpesaConfig.timeout;\n                var cont = true;\n                const b = '</div>';\n                arrayints.forEach(function(el, index) {\n                    setTimeout(function() {\n                        if (cont == true) {\n                            var progressDiv = modal.getRoot().find('#mpesa-progress_bar');\n                            progressDiv.attr('value', el * 10);\n                            if (mpesaPay.xreferenceid != '') {\n                                Ajax.call([{\n                                    methodname: \"paygw_mpesakenya_transaction_complete\",\n                                    args: {\n                                        component,\n                                        paymentarea: paymentArea,\n                                        itemid: itemId,\n                                        merchantrequestid: merchantrequestid,\n                                    },\n                                    done: function(mpesaPing) {\n                                        modal.setFooter(el + '/10 ' + mpesaPing.message);\n                                        var spinnerDiv = modal.getRoot().find('#mpesa-spinner');\n                                        if (mpesaPing.success) {\n                                            if (mpesaPing.message == 'SUCCESSFUL') {\n                                                cont = false;\n                                                progressDiv.attr('value', 100);\n                                                spinnerDiv.attr('style', 'display: none;');\n                                                var cancelButton = modal.getRoot().find('#mpesa-cancel');\n                                                cancelButton.attr('style', 'display: none;');\n                                                var payButton = modal.getRoot().find('#mpesa-pay');\n                                                payButton.removeAttr('disabled');\n                                                modal.setFooter('Transaction '+ merchantrequestid + ' Succes');\n                                                payButton.on('click', function() {\n                                                    const loc = window.location.href;\n                                                    window.location.replace(loc);\n                                                });\n                                            }\n                                            if (mpesaPing.message == 'ERROR') {\n                                                cont = false;\n                                                const a = '<br/><div class=\"p-3 mb-2 bg-danger text-white font-weight-bold\">';\n                                                var outDiv = modal.getRoot().find('#mpesa-out');\n                                                outDiv.append(a + mpesaPing.desc + b);\n                                                spinnerDiv.attr('style', 'display: none;');\n                                                return;\n\n                                            }\n                                        } else {\n                                            cont = false;\n                                            const a = '<br/><div class=\"p-3 mb-2 bg-danger text-white font-weight-bold\">';\n                                            var outDiv = modal.getRoot().find('#mpesa-out');\n                                            outDiv.append(a + mpesaPing.message + b);\n                                            spinnerDiv.attr('style', 'display: none;');\n                                            return;\n                                        }\n                                    },\n                                    fail: function(e) {\n                                        console.log(getString('failed', 'paygw_mpesakenya'));  // eslint-disable-line\n                                        Log.debug(e);\n                                    }\n                                }]);\n                                if (el > 9) {\n                                    modal.destroy();\n                                }\n                            }\n                        }\n                    }, index * interval);\n                });\n                return new Promise(() => null);\n            }).catch(function(res) {\n                console.log(res);\n                modal.setBody(getString('unable', 'paygw_mpesakenya'));\n                console.log('Unable to connect to MPesa');  // eslint-disable-line\n            });\n        });\n        return new Promise(() => null);\n    }).catch(e => {\n        Log.debug('Global error.');\n        Log.debug(e);\n        return Promise.reject(e.message);\n    });\n};\n"],"names":["_getRequireWildcardCache","nodeInterop","WeakMap","cacheBabelInterop","cacheNodeInterop","_interopRequireDefault","obj","__esModule","default","_jquery","Repository","cache","has","get","newObj","hasPropertyDescriptor","Object","defineProperty","getOwnPropertyDescriptor","key","prototype","hasOwnProperty","call","desc","set","_interopRequireWildcard","_ajax","_config","_log","_modal_factory","_modal_events","_templates","showModalWithPlaceholder","async","console","table","mpesaConfig","modal","ModalFactory","create","body","Templates","render","show","_exports","process","component","paymentArea","itemId","description","Promise","all","getConfigForJs","then","_ref","log","_ref2","setTitle","getString","getRoot","on","ModalEvents","hidden","destroy","_ref3","cancelButton","find","payButton","removeAttr","e","preventDefault","phone","$","val","transactionStart","_ref4","mpesaPay","merchantrequestid","setBody","sesskey","Config","country","paymentarea","itemid","reference","attr","interval","timeout","cont","b","forEach","el","index","setTimeout","progressDiv","xreferenceid","Ajax","methodname","args","done","mpesaPing","setFooter","message","spinnerDiv","success","a","append","loc","window","location","href","replace","fail","Log","debug","catch","res","reject"],"mappings":"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"}