{"version":3,"file":"gateways_modal.min.js","sources":["../src/gateways_modal.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * This module is responsible for MTN Africa content in the gateways modal.\n *\n * @copyright  2023 Medical Access Uganda Limited\n * @author     Renaat Debleu <info@eWallah.net>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\nimport $ from 'jquery';\nimport * as Repository from './repository';\nimport Ajax from 'core/ajax';\nimport Config from 'core/config';\nimport Log from 'core/log';\nimport ModalFactory from 'core/modal_factory';\nimport ModalEvents from 'core/modal_events';\nimport Templates from 'core/templates';\nimport {get_string as getString} from 'core/str';\n\n/**\n * Creates and shows a modal that contains a placeholder.\n * @param {mtnConfig} mtnConfig\n *\n * @returns {Promise<Modal>}\n */\nconst showModalWithPlaceholder = async(mtnConfig) => {\n    const modal = await ModalFactory.create({\n        body: await Templates.render('paygw_mtnafrica/placeholder', mtnConfig)\n    });\n    modal.show();\n    return modal;\n};\n\n/**\n * Process the payment.\n *\n * @param {string} component Name of the component that the itemId belongs to\n * @param {string} paymentArea The area of the component that the itemId belongs to\n * @param {number} itemId An internal identifier that is used by the component\n * @param {string} description Description of the payment\n * @returns {Promise<string>}\n */\nexport const process = (component, paymentArea, itemId, description) => {\n    return Promise.all([\n        Repository.getConfigForJs(component, paymentArea, itemId),\n    ])\n    .then(([mtnConfig]) => {\n        return Promise.all([\n        showModalWithPlaceholder(mtnConfig),\n    ])\n    .then(([modal]) => {\n        modal.setTitle(getString('pluginname', 'paygw_mtnafrica'));\n        modal.getRoot().on(ModalEvents.hidden, () => {\n            // Destroy when hidden.\n            console.log('Destroy modal');  // eslint-disable-line\n            modal.destroy();\n        });\n        return Promise.all([modal, mtnConfig]);\n    });\n    })\n    .then(([modal, mtnConfig]) => {\n        var cancelButton = modal.getRoot().find('#mtn-cancel');\n        cancelButton.on('click', function() {\n            modal.destroy();\n        });\n        var payButton = modal.getRoot().find('#mtn-pay');\n        payButton.removeAttr('disabled');\n        payButton.on('click', function(e) {\n            e.preventDefault();\n            var radioval = $(\"input[name='mtnnumber']:checked\").val();\n            var mobilenumber = $(\"input[name='mobilenumber']\").val();\n            var phone = (mtnConfig.phone)?(radioval =='other')? mobilenumber : mtnConfig.phone :mobilenumber;\n            Promise.all([\n                Repository.transactionStart(component, paymentArea, itemId, phone),\n            ])\n            .then(([mtnPay]) => {\n                const transId = mtnPay.transactionid;\n                modal.setBody(Templates.render('paygw_mtnafrica/busy', {\n                    \"sesskey\": Config.sesskey,\n                    \"phone\": phone,\n                    \"country\": mtnConfig.country,\n                    \"component\": component,\n                    \"paymentarea\": paymentArea,\n                    \"transactionid\": transId,\n                    \"itemid\": itemId,\n                    \"description\": description,\n                    \"reference\": mtnConfig.reference,\n                }));\n                cancelButton = modal.getRoot().find('#mtn-cancel');\n                cancelButton.on('click', function() {\n                    e.preventDefault();\n                    modal.destroy();\n                });\n                payButton = modal.getRoot().find('#mtn-pay');\n                payButton.on('click', function() {\n                    modal.destroy();\n                });\n                payButton.attr('disabled', true);\n                console.log('mtn Africa payment process started');  // eslint-disable-line\n                console.log('Reference id: ' + transId);  // eslint-disable-line\n                var arrayints = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10];\n                var interval = mtnConfig.timeout;\n                var cont = true;\n                const b = '</div>';\n                arrayints.forEach(function(el, index) {\n                    setTimeout(function() {\n                        if (cont == true) {\n                            var progressDiv = modal.getRoot().find('#mtn-progress_bar');\n                            console.log(el); // eslint-disable-line\n                            progressDiv.attr('value', el * 10);\n                            if (mtnPay.xreferenceid != '') {\n                                Ajax.call([{\n                                    methodname: \"paygw_mtnafrica_transaction_complete\",\n                                    args: {\n                                        component,\n                                        paymentarea: paymentArea,\n                                        itemid: itemId,\n                                        xreferenceid: transId,\n                                    },\n                                    done: function(mtnPing) {\n                                        modal.setFooter(el + '/10 ' + mtnPing.message);\n                                        console.log(el + '/10 ' + mtnPing.message);  // eslint-disable-line\n                                        var spinnerDiv = modal.getRoot().find('#mtn-spinner');\n                                        if (mtnPing.success) {\n                                            if (mtnPing.message == 'SUCCESSFUL') {\n                                                cont = false;\n                                                progressDiv.attr('value', 100);\n                                                spinnerDiv.attr('style', 'display: none;');\n                                                $('#mtn-progress_bar').val(100);\n                                                var cancelButton = modal.getRoot().find('#mtn-cancel');\n                                                cancelButton.attr('style', 'display: none;');\n                                                var payButton = modal.getRoot().find('#mtn-pay');\n                                                payButton.removeAttr('disabled');\n                                                modal.setFooter('Transaction '+ transId + ' Succes');\n                                                payButton.on('click', function() {\n                                                    const loc = window.location.href;\n                                                    window.location.replace(loc);\n                                                });\n                                                const a = '<br/><div class=\"p-3 mb-2 text-success font-weight-bold\">';\n                                                const outDiv = modal.getRoot().find('#mtn-out');\n                                                outDiv.append(a + mtnPing.message + '</div>');\n                                            } else if (mtnPing.message == 'PENDING') {\n                                                spinnerDiv.attr('style', 'display: none;');\n                                                var cancelButton = modal.getRoot().find('#mtn-cancel');\n                                                cancelButton.attr('style', 'display: none;');\n                                                var payButton = modal.getRoot().find('#mtn-pay');\n                                                payButton.removeAttr('disabled');\n                                                modal.setFooter('Transaction '+ transId + ' Pending');\n                                                payButton.on('click', function() {\n                                                    const loc = window.location.href;\n                                                    window.location.replace(loc);\n                                                });\n                                                const a = '<br/><div class=\"p-3 mb-2 text-info font-weight-bold\">';\n                                                const outDiv = modal.getRoot().find('#mtn-out');\n                                                outDiv.append(a + mtnPing.message + '</div>');\n\n                                            }\n                                        } else {\n                                            cont = false;\n                                            const a = '<br/><div class=\"p-3 mb-2 bg-danger text-white font-weight-bold\">';\n                                            var outDiv = modal.getRoot().find('#mtn-out');\n                                            outDiv.append(a + mtnPing.message + b);\n                                            spinnerDiv.attr('style', 'display: none;');\n                                            return;\n                                        }\n                                    },\n                                    fail: function(e) {\n                                        console.log(getString('failed', 'paygw_mtnafrica'));  // eslint-disable-line\n                                        Log.debug(e);\n                                    }\n                                }]);\n                                if (el > 9) {\n                                    modal.destroy();\n                                }\n                            }\n                        }\n                    }, index * interval);\n                });\n                return new Promise(() => null);\n            }).catch(function() {\n                modal.setBody(getString('unable', 'paygw_mtnafrica'));\n                console.log('Unable to connect to MTN');  // eslint-disable-line\n            });\n        });\n        return new Promise(() => null);\n    }).catch(e => {\n        Log.debug('Global error.');\n        Log.debug(e);\n        return Promise.reject(e.message);\n    });\n};\n"],"names":["_getRequireWildcardCache","nodeInterop","WeakMap","cacheBabelInterop","cacheNodeInterop","_interopRequireDefault","obj","__esModule","default","_jquery","Repository","cache","has","get","newObj","hasPropertyDescriptor","Object","defineProperty","getOwnPropertyDescriptor","key","prototype","hasOwnProperty","call","desc","set","_interopRequireWildcard","_ajax","_config","_log","_modal_factory","_modal_events","_templates","showModalWithPlaceholder","async","modal","ModalFactory","create","body","Templates","render","mtnConfig","show","_exports","process","component","paymentArea","itemId","description","Promise","all","getConfigForJs","then","_ref","_ref2","setTitle","getString","getRoot","on","ModalEvents","hidden","console","log","destroy","_ref3","cancelButton","find","payButton","removeAttr","e","preventDefault","radioval","$","val","mobilenumber","phone","transactionStart","_ref4","mtnPay","transId","transactionid","setBody","sesskey","Config","country","paymentarea","itemid","reference","attr","interval","timeout","cont","forEach","el","index","setTimeout","progressDiv","xreferenceid","Ajax","methodname","args","done","mtnPing","setFooter","message","spinnerDiv","success","a","append","loc","window","location","href","replace","fail","Log","debug","catch","reject"],"mappings":"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"}