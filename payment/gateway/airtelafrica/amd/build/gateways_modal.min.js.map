{"version":3,"file":"gateways_modal.min.js","sources":["../src/gateways_modal.js"],"sourcesContent":["import $ from 'jquery';\nimport * as Repository from './repository';\nimport Ajax from 'core/ajax';\nimport Config from 'core/config';\nimport Log from 'core/log';\nimport ModalFactory from 'core/modal_factory';\nimport ModalEvents from 'core/modal_events';\nimport Templates from 'core/templates';\nimport {get_string as getString} from 'core/str';\n\n/**\n * Creates and shows a modal that contains a placeholder.\n * @param {object} airtelConfig\n *\n * @returns {Promise<Modal>}\n */\nconst showModalWithPlaceholder = async(airtelConfig) => {\n    const modal = await ModalFactory.create({\n        body: await Templates.render('paygw_airtelafrica/placeholder', airtelConfig)\n    });\n    modal.show();\n    return modal;\n};\n\n/**\n * Process the payment.\n *\n * @param {string} component Name of the component that the itemId belongs to\n * @param {string} paymentArea The area of the component that the itemId belongs to\n * @param {number} itemId An internal identifier that is used by the component\n * @param {string} description Description of the payment\n * @returns {Promise<string>}\n */\nexport const process = (component, paymentArea, itemId, description) => {\n    return Promise.all([\n        Repository.getConfigForJs(component, paymentArea, itemId),\n    ])\n    .then(([airtelConfig]) => {\n        return Promise.all([\n            showModalWithPlaceholder(airtelConfig),\n        ])\n        .then(([modal]) => {\n            modal.setTitle(getString('pluginname', 'paygw_airtelafrica'));\n            modal.getRoot().on(ModalEvents.hidden, () => {\n                // Destroy when hidden.\n                console.log('Destroy modal');    // eslint-disable-line\n                modal.destroy();\n            });\n            return Promise.all([modal, airtelConfig]);\n        });\n    })\n    .then(([modal, airtelConfig]) => {\n        var cancelButton = modal.getRoot().find('#airtel-cancel');\n        cancelButton.on('click', function() {\n            modal.destroy();\n        });\n        var payButton = modal.getRoot().find('#airtel-pay');\n        payButton.removeAttr('disabled');\n        payButton.on('click', function(e) {\n            e.preventDefault();\n            var radioval = $(\"input[name='airtelnumber']:checked\").val();\n            var mobilenumber = $(\"input[name='mobilenumber']\").val();\n            var phone = (airtelConfig.phone) ? (radioval =='other') ? mobilenumber : airtelConfig.phone : mobilenumber;\n            Promise.all([\n                Repository.transactionStart(component, paymentArea, itemId, phone),\n            ])\n            .then(([airtelPay]) => {\n                const transId = airtelPay.transactionid;\n                modal.setBody(Templates.render('paygw_airtelafrica/busy', {\n                    \"sesskey\": Config.sesskey,\n                    \"phone\": phone,\n                    \"country\": airtelConfig.country,\n                    \"component\": component,\n                    \"paymentarea\": paymentArea,\n                    \"transactionid\": transId,\n                    \"itemid\": itemId,\n                    \"description\": description,\n                    \"reference\": airtelConfig.reference,\n                }));\n                cancelButton = modal.getRoot().find('#airtel-cancel');\n                cancelButton.on('click', function() {\n                    e.preventDefault();\n                    modal.destroy();\n                });\n                payButton = modal.getRoot().find('#airtel-pay');\n                payButton.on('click', function() {\n                    modal.destroy();\n                });\n                payButton.attr('disabled', true);\n                console.log('Airtel Africa payment process started');  // eslint-disable-line\n                console.log('Transaction id: ' + transId);  // eslint-disable-line\n                var arrayints = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10];\n                var interval = airtelConfig.timeout;\n                var cont = true;\n                console.log(modal); // eslint-disable-line\n                arrayints.forEach(function(el, index) {\n                    setTimeout(function() {\n                        if (cont == true) {\n                            const progressDiv = modal.getRoot().find('#airtel-progress_bar');\n                            progressDiv.attr('value', el * 10);\n                            payButton.attr('disabled', true);\n                            if (transId != '') {\n                                modal.setFooter(el + '/10');\n                                Ajax.call([{\n                                    methodname: \"paygw_airtelafrica_transaction_complete\",\n                                    args: {\n                                        component,\n                                        paymentarea: paymentArea,\n                                        itemid: itemId,\n                                        transactionid: transId,\n                                    },\n                                    done: function(airtelPing) {\n                                        console.log(el + '/10 ' + airtelPing.message);  // eslint-disable-line\n                                        console.log(airtelPing.message); // eslint-disable-line\n                                        if (airtelPing.message == \"Transaction Success\") {\n                                            cont = (el == 1)? true : false;\n                                            var payButton = modal.getRoot().find('#airtel-pay');\n                                            payButton.on('click', function() {\n                                                const loc = window.location.href;\n                                                window.location.replace(loc);\n                                            });\n                                            progressDiv.attr('value', 100);\n                                            modal.setFooter('Transaction with id ' + transId + ' succeeded');\n                                            const spinnerElement = modal.getRoot().find('#airtel-spinner');\n                                            spinnerElement.attr('style', 'display: none;');\n                                            const a = '<br/><div class=\"p-3 mb-2 text-success font-weight-bold\">';\n                                            const outDiv = modal.getRoot().find('#airtel-out');\n                                            if (cont == false) {\n                                                outDiv.append(a + airtelPing.message + '</div>');\n                                                payButton.removeAttr('disabled');\n                                            }\n                                        }\n                                        if (airtelPing.message == \"Transaction Failed\") {\n                                            cont = false;\n                                            const a = '<br/><div class=\"p-3 mb-2 bg-danger text-white font-weight-bold\">';\n                                            modal.setBody(a + airtelPing.message + '</div>');\n                                            modal.setFooter('Transaction with id ' + transId + ' failed');\n                                            const spinnerElement = modal.getRoot().find('#airtel-spinner');\n                                            console.log(spinnerElement);  // eslint-disable-line\n                                            spinnerElement.hide();\n                                        }\n                                    },\n                                    fail: function(e) {\n                                        console.log('Airtel Africa payment failed');  // eslint-disable-line\n                                        Log.debug(e);\n                                    }\n                                }]);\n\n                                if (el > 9) {\n                                    modal.destroy();\n                                }\n                            }\n                        }\n                    }, index * interval);\n                });\n                return new Promise(() => null);\n            }).catch(e => {\n                // We want to use promise reject here - as that's what core payment stuff expects.\n                modal.setBody(getString('unable', 'paygw_airtelafrica'));\n                console.log('Airtel Africa payment rejected');  // eslint-disable-line\n                Log.debug('Airtel Africa payment rejected');\n                Log.debug(e);\n            });\n        });\n        return new Promise(() => null);\n    }).catch(e => {\n        Log.debug('Global error.');\n        Log.debug(e);\n        return Promise.reject(e.message);\n    });\n};\n"],"names":["_getRequireWildcardCache","nodeInterop","WeakMap","cacheBabelInterop","cacheNodeInterop","_interopRequireDefault","obj","__esModule","default","_jquery","Repository","cache","has","get","newObj","hasPropertyDescriptor","Object","defineProperty","getOwnPropertyDescriptor","key","prototype","hasOwnProperty","call","desc","set","_interopRequireWildcard","_ajax","_config","_log","_modal_factory","_modal_events","_templates","showModalWithPlaceholder","async","modal","ModalFactory","create","body","Templates","render","airtelConfig","show","_exports","process","component","paymentArea","itemId","description","Promise","all","getConfigForJs","then","_ref","_ref2","setTitle","getString","getRoot","on","ModalEvents","hidden","console","log","destroy","_ref3","cancelButton","find","payButton","removeAttr","e","preventDefault","radioval","$","val","mobilenumber","phone","transactionStart","_ref4","airtelPay","transId","transactionid","setBody","sesskey","Config","country","paymentarea","itemid","reference","attr","interval","timeout","cont","forEach","el","index","setTimeout","progressDiv","setFooter","Ajax","methodname","args","done","airtelPing","message","loc","window","location","href","replace","a","outDiv","append","spinnerElement","hide","fail","Log","debug","catch","reject"],"mappings":"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"}